---
import { db } from "@bandori-stats/database";
import {
	SELECT_STAT_COLUMNS,
	STAT_COLUMNS,
} from "@bandori-stats/database/constants";
import { titleCase } from "text-case";

import BaseLayout from "~/layouts/base-layout.astro";

const params = Astro.url.searchParams;

const pageSize = 50;
const nextPage = async () => {
	const cursor = Number(params.get("cursor") ?? NaN);

	return db.query.accounts
		.findMany({
			columns: { id: true, username: true },
			with: {
				latestSnapshot: {
					columns: { ...SELECT_STAT_COLUMNS, snapshotDate: true },
				},
			},
			where: ({ id }, { gt }) =>
				!Number.isNaN(cursor) ? gt(id, cursor) : undefined,
			orderBy: ({ id }) => id,
			limit: pageSize,
		})
		.then((entries) =>
			entries
				.map(({ id, username, latestSnapshot }) =>
					latestSnapshot ? { id, username, latestSnapshot } : null,
				)
				.filter((entry) => entry !== null),
		);
};

const nextPageHtmxProps = (cursor: number) => {
	const nextPageUrl = new URL(Astro.url);
	nextPageUrl.searchParams.set("cursor", cursor.toString());

	return {
		"hx-get": nextPageUrl.href,
		"hx-select": "tbody > tr",
		"hx-swap": "afterend",
		"hx-trigger": "intersect once",
	};
};

const entries = await nextPage();
---

<BaseLayout>
	<div class="absolute inset-0 overflow-x-auto">
		<table class="table-xs table">
			<thead>
				<tr class="bg-base-100 sticky top-0 z-10">
					<th>Username</th>
					<th>Last updated</th>
					{STAT_COLUMNS.map((column) => <th>{titleCase(column)}</th>)}
				</tr>
			</thead>

			<tbody>
				{
					entries.map(({ id, username, latestSnapshot }, idx) => (
						<tr {...(idx === pageSize - 1 ? nextPageHtmxProps(id) : {})}>
							<th class="bg-base-100/20 sticky left-0 pl-0 shadow-sm">
								<p class="w-36 overflow-clip text-ellipsis">
									<span class="bg-base-100 px-4">{username}</span>
								</p>
							</th>
							<td>{latestSnapshot.snapshotDate}</td>

							{STAT_COLUMNS.map((column) => (
								<td>
									{latestSnapshot[column] ? (
										latestSnapshot[column]
									) : (
										<b class="text-base-content/40">Private</b>
									)}
								</td>
							))}
						</tr>
					))
				}
			</tbody>
		</table>
	</div>
</BaseLayout>
