---
import { STAT_NAMES } from "@bandori-stats/bestdori/constants";
import { db, eq } from "@bandori-stats/database";
import { accountSnapshots } from "@bandori-stats/database/schema";

import { paginate } from "~/lib/paginate";
import { dateSchema } from "~/lib/schema";
import DisplayName from "./_display-name.astro";
import StatsBadge from "./_stats-badge.astro";

export const partial = true;

const id = Number(Astro.params.id);
const date = dateSchema.parse(Astro.locals.query.date);
const page = await paginate({
	items: {
		get: async (limit, offset) =>
			db.query.accounts.findFirst({
				columns: { username: true, nickname: true },
				extras: {
					snapshotsCount: db.$count(
						accountSnapshots,
						eq(accountSnapshots.accountId, id),
					),
				},
				with: {
					snapshots: {
						limit: limit + 1,
						offset,
						columns: { stats: true, snapshotDate: true },
						where: { snapshotDate: { lte: date } },
						orderBy: { snapshotDate: "desc" },
					},
				},
				where: { id },
			}),
		hasNextPage: (limit, offset, it) =>
			it?.snapshotsCount !== undefined && offset + limit < it.snapshotsCount,
	},
	context: Astro,
	extraProps: {
		"hx-indicator": "#snapshot-loader",
		"hx-select": ".snapshot",
		"hx-swap": "afterend",
		"hx-vals": JSON.stringify({ date }),
	},
	size: 7,
});

const account = page.items[0];
const isNotFound = !account || account.snapshots.length === 0;
if (isNotFound) Astro.response.status = 404;
---

<dialog class="modal modal-bottom sm:modal-middle">
	<div class="modal-box max-sm:max-h-4/5">
		<form method="dialog">
			<button class="btn btn-sm btn-circle btn-ghost absolute top-2 right-2">
				âœ•
			</button>
		</form>

		{
			isNotFound ? (
				<h2 class="text-center text-lg font-bold">Stats not found</h2>
			) : (
				<>
					<h2 class="text-center">
						<span class="text-lg font-bold">Stats History</span> <br />
						<DisplayName
							username={account.username}
							nickname={account.nickname}
						/>
					</h2>

					<div class="mt-4 flex justify-center">
						<button
							class="btn btn-accent btn-sm"
							hx-get={`/fragments/stats-history/${id}/chart`}
						>
							Growth Chart
							<iconify-icon
								icon="lucide:chart-line"
								width="none"
								class="htmx-indicator-replace size-4"
							/>
							<iconify-icon
								icon="svg-spinners:90-ring-with-bg"
								width="none"
								class="htmx-indicator size-4"
							/>
						</button>
					</div>

					<div class="mt-4 flex flex-1 flex-col gap-4 overflow-auto">
						{account.snapshots
							.slice(0, page.size)
							.map(({ snapshotDate, stats }, idx) => (
								<div
									{...(page.isLastElement(idx) && page.props)}
									class="snapshot relative flex gap-2"
								>
									<div class="flex w-28 flex-col gap-0.5">
										<span class="text-center font-medium">{snapshotDate}</span>

										{stats.titles !== null && stats.titles.length > 0 && (
											<div class="dropdown dropdown-right">
												<div
													tabindex="0"
													role="button"
													class="btn btn-info btn-xs w-full"
												>
													Show Titles
													<iconify-icon
														icon="lucide:award"
														width="none"
														class="size-3.5"
													/>
												</div>
												<div
													tabindex="-1"
													class="dropdown-content bg-base-100 rounded-box z-10 ml-1 max-h-22 w-[200%] -translate-y-8 overflow-y-auto p-2 shadow-md sm:w-[300%]"
												>
													<div
														hx-indicator="closest .titles"
														hx-vals={JSON.stringify({ date: snapshotDate })}
														class="titles flex flex-wrap justify-center gap-x-1 gap-y-1.5 *:w-24 sm:*:w-32"
													>
														<div
															hx-get={`/fragments/stats-history/${id}/titles`}
															hx-swap="outerHTML"
															hx-trigger="intersect once"
															class="skeleton aspect-23/5"
														/>

														{Array.from(
															{ length: Math.min(stats.titles.length - 1, 5) },
															() => (
																<div class="htmx-indicator skeleton aspect-23/5" />
															),
														)}
													</div>
												</div>
											</div>
										)}
									</div>

									<div class="flex flex-1 flex-wrap gap-1">
										{[...STAT_NAMES, "titles" as const].map((name) => (
											<StatsBadge
												label={name}
												value={stats[name]}
												previousValue={
													account.snapshots.at(idx + 1)?.stats[name]
												}
											/>
										))}
									</div>
								</div>
							))}
					</div>

					<div
						id="snapshot-loader"
						class="htmx-indicator mt-4 flex flex-col items-center"
					>
						<iconify-icon
							icon="svg-spinners:90-ring-with-bg"
							width="none"
							class="size-24"
						/>

						<span class="font-medium">loading more snapshots...</span>
					</div>
				</>
			)
		}
	</div>

	<form method="dialog" class="contents">
		<button class="modal-backdrop">Close</button>
	</form>
</dialog>
