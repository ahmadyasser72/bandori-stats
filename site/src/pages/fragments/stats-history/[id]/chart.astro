---
import { STAT_NAMES } from "@bandori-stats/bestdori/constants";
import { getValue } from "@bandori-stats/bestdori/helpers";
import { db } from "@bandori-stats/database";

import { titleCase } from "text-case";
import z from "zod";

import { defineLineChart } from "~/lib/chart";
import DisplayName from "./_display-name.astro";

export const partial = true;

const id = Number(Astro.params.id);
const statName = z
	.enum(STAT_NAMES)
	.catch("bandRating")
	.parse(Astro.locals.query.stat_name);
const account = await db.query.accounts.findFirst({
	columns: { username: true, nickname: true },
	with: {
		snapshots: {
			columns: { stats: true, snapshotDate: true },
			orderBy: { snapshotDate: "asc" },
		},
	},
	where: { id },
});

const isNotFound = !account || account.snapshots.length === 0;
if (isNotFound) Astro.response.status = 404;

const chart = isNotFound
	? {}
	: defineLineChart([
			{
				label: `@${account.username}`,
				data: account.snapshots.map(
					({ stats, snapshotDate }, idx, snapshots) => {
						const current = stats[statName];
						const previous =
							idx > 0 ? snapshots[idx - 1].stats[statName] : undefined;

						return {
							x: snapshotDate,
							y:
								current !== null && current !== previous
									? getValue(current)
									: NaN,
						};
					},
				),
			},
		]);
---

<dialog class="modal modal-bottom sm:modal-middle">
	<div class="modal-box">
		<form method="dialog">
			<button class="btn btn-sm btn-circle btn-ghost absolute top-2 right-2">
				âœ•
			</button>
		</form>

		{
			isNotFound ? (
				<h3 class="text-center text-lg font-bold">Stats not found</h3>
			) : (
				<>
					<h2 class="text-center">
						<span class="text-lg font-bold">Growth chart</span> <br />
						<DisplayName
							username={account.username}
							nickname={account.nickname}
						/>
					</h2>

					<div
						id="chart"
						class="relative mx-auto mt-4 aspect-2/1 w-96 max-w-full"
					>
						<canvas {...chart} class="bg-base-100" />
						<iconify-icon
							icon="svg-spinners:3-dots-rotate"
							width="none"
							class="center absolute -z-10 size-24"
						/>
					</div>

					<div class="mt-2 flex justify-center">
						<div class="join w-64">
							<select
								class="select join-item"
								name="stat_name"
								hx-indicator="#chart-loader"
								hx-get={`/fragments/stats-history/${id}/chart`}
								hx-target="#chart"
								hx-select="#chart"
							>
								<option disabled>Pick a stat</option>
								{STAT_NAMES.map((name) => (
									<option value={name} selected={statName === name}>
										{titleCase(name)}
									</option>
								))}
							</select>

							<button id="chart-loader" class="btn join-item btn-square">
								<iconify-icon
									icon="lucide:activity"
									width="none"
									class="htmx-indicator-replace size-4"
								/>
								<iconify-icon
									icon="svg-spinners:90-ring-with-bg"
									width="none"
									class="htmx-indicator size-4"
								/>
							</button>
						</div>
					</div>
				</>
			)
		}
	</div>

	<form method="dialog" class="contents">
		<button class="modal-backdrop">Close</button>
	</form>
</dialog>
