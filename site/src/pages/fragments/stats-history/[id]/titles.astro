---
import { db } from "@bandori-stats/database";

import { parseDate } from "~/lib/date";
import { paginate } from "~/lib/paginate";

export const partial = true;

const id = Number(Astro.params.id);
const date = parseDate(Astro.url.searchParams.get("date"));
const account = await db.query.accounts.findFirst({
	columns: { id: true, username: true, nickname: true },
	with: {
		snapshots: {
			limit: 2,
			columns: { stats: true },
			where: { snapshotDate: { lte: date } },
			orderBy: { snapshotDate: "desc" },
		},
	},
	where: { id },
});

const latestSnapshot = account?.snapshots[0];
const previousSnapshot = account?.snapshots[1];

const titles = latestSnapshot?.stats.titles ?? null;

const isNotFound = !account || !latestSnapshot || titles === null;
if (isNotFound) Astro.response.status = 404;

const previousTitles = new Set(previousSnapshot?.stats.titles ?? []);
const sortedTitles = titles!
	.map((title) => ({
		value: title,
		isNew: previousTitles.size > 0 ? !previousTitles.has(title) : true,
	}))
	.sort((a, b) => (a.isNew === b.isNew ? 0 : a.isNew ? -1 : 1));

const page = paginate({
	items: sortedTitles,
	context: Astro,
	size: 24,
	extraProps: {
		"hx-swap": "afterend",
	},
});
---

{
	page.items.map(({ value: title, isNew }, idx) => (
		<img
			{...(page.isLastElement(idx) && page.props)}
			src={`/static/titles/${title}.webp`}
			loading="lazy"
			class:list={[
				"border-base-content/60 skeleton aspect-23/5 rounded-2xl border",
				isNew && "border-secondary ring-secondary bg-secondary ring-2",
			]}
		/>
	))
}
