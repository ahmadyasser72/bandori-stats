---
import { db } from "@bandori-stats/database";
import {
	SELECT_STAT_COLUMNS,
	STAT_COLUMNS,
} from "@bandori-stats/database/constants";
import { redis } from "@bandori-stats/database/redis";
import { titleCase } from "text-case";

import { useRadarChart } from "~/lib/chart";
import { formatNumber } from "~/lib/math";
import { schema } from "../../_params";

export const partial = true;

const id = Number(Astro.params.id);
const date = schema.date.parse(Astro.params.date);
const account = await db.query.accounts.findFirst({
	columns: { id: true, username: true },
	with: {
		snapshots: {
			limit: 1,
			columns: { ...SELECT_STAT_COLUMNS },
			orderBy: (t, { desc }) => desc(t.snapshotDate),
			where: (t, { lte }) => lte(t.snapshotDate, date),
		},
	},
	where: (t, { eq }) => eq(t.id, id),
});

const isNotFound = !account || account.snapshots.length === 0;
if (isNotFound) Astro.response.status = 404;

const chart = await (async () => {
	if (isNotFound) return;

	return useRadarChart({
		type: "radar",
		options: {
			elements: { point: { radius: 5 } },
			scales: { r: { min: 0, max: 1, ticks: { display: false } } },
			plugins: { tooltip: { enabled: true } },
		},
		data: {
			labels: STAT_COLUMNS.map((column) =>
				titleCase(column.replace(/Count$/, "")),
			),
			datasets: [
				{
					label: `${account.username} (${date})`,
					fill: true,
					normalized: true,
					parsing: { key: "value" },
					data: await Promise.all(
						STAT_COLUMNS.map(async (column) => {
							const value = account.snapshots[0][column];

							const leaderboard = `leaderboard:${date}:${column}`;
							const n = await redis.zcard(leaderboard);
							const rank =
								(await redis.zrevrank(leaderboard, account.id)) ?? n - 1;

							return {
								tooltip: [
									value === null ? "Private" : formatNumber(value),
									`(#${rank + 1})`,
								].join(" "),
								value: value === null ? 0 : 1 - rank / (n - 1),
							};
						}),
					),
				},
			],
		},
	});
})();
---

<dialog
	class="modal modal-bottom sm:modal-middle"
	hx-on:close="this.ontransitionend = this.remove"
>
	<div class="modal-box">
		<form method="dialog">
			<button class="btn btn-sm btn-circle btn-ghost absolute top-2 right-2">
				âœ•
			</button>
		</form>

		{
			isNotFound ? (
				<h2 class="text-lg font-bold">Stats not found</h2>
			) : (
				<>
					<h2 class="text-lg font-bold">
						Stats chart for {account.username} ({date})
					</h2>

					<main hx-target="this" class="mt-4 flex flex-col gap-4">
						<div class="relative mx-auto aspect-square w-96 max-w-full">
							<canvas {...chart} />
						</div>
					</main>
				</>
			)
		}
	</div>

	<form method="dialog" class="contents">
		<button class="modal-backdrop">Close</button>
	</form>
</dialog>
