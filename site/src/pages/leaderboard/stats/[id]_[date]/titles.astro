---
import { db } from "@bandori-stats/database";

import { schema } from "../../_params";

export const partial = true;

const id = Number(Astro.params.id);
const date = schema.date.parse(Astro.params.date);
const account = await db.query.accounts.findFirst({
	columns: { id: true, username: true, nickname: true },
	with: {
		snapshots: {
			limit: 2,
			columns: { stats: true },
			where: { snapshotDate: { lte: date } },
			orderBy: { snapshotDate: "desc" },
		},
	},
	where: { id },
});

const latestSnapshot = account?.snapshots[0];
const previousSnapshot = account?.snapshots[1];

const titles = latestSnapshot?.stats.titles ?? null;

const isNotFound = !account || !latestSnapshot || titles === null;
if (isNotFound) Astro.response.status = 404;

const previousTitles = new Set(previousSnapshot?.stats.titles ?? []);
const sortedTitles = titles!
	.map((title) => ({
		value: title,
		isNew: previousTitles.size > 0 ? !previousTitles.has(title) : true,
	}))
	.sort((a, b) => (a.isNew === b.isNew ? 0 : a.isNew ? -1 : 1));

const page = schema.page.parse(Astro.url.searchParams.get("page"));
const pageSize = 24;
const offset = (page - 1) * pageSize;
const pageTitles = sortedTitles.slice(offset, offset + pageSize);

const nextPageHtmxProps = (() => {
	if (offset + pageSize > sortedTitles.length) return {};

	const nextPageUrl = new URL(Astro.url);
	nextPageUrl.search = "";
	nextPageUrl.searchParams.set("page", (page + 1).toString());
	return {
		"hx-get": nextPageUrl.href,
		"hx-swap": "afterend",
		"hx-trigger": "intersect once",
	};
})();
---

{
	pageTitles.map(({ value: title, isNew }, idx) => (
		<img
			{...(idx === pageSize - 1 ? nextPageHtmxProps : {})}
			src={`/static/titles/${title}.webp`}
			loading="lazy"
			class:list={[
				"border-base-content/60 skeleton aspect-23/5 rounded-2xl border",
				isNew && "border-secondary ring-secondary bg-secondary ring-2",
			]}
		/>
	))
}
