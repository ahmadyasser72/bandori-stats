---
import { db } from "@bandori-stats/database";
import {
	SELECT_STAT_COLUMNS,
	STAT_COLUMNS,
} from "@bandori-stats/database/constants";

import StatsBadge from "./_stats-badge.astro";

export const partial = true;

const account = await db.query.accounts.findFirst({
	columns: { username: true },
	with: {
		snapshots: { columns: { ...SELECT_STAT_COLUMNS, snapshotDate: true } },
	},
	where: (t, { eq }) => eq(t.id, Number(Astro.params.id)),
});

const isNotFound = !account || account.snapshots.length === 0;
if (isNotFound) Astro.response.status = 404;
---

<dialog
	class="modal modal-bottom sm:modal-middle"
	hx-on:close="this.ontransitionend = this.remove"
>
	<div class="modal-box">
		<form method="dialog">
			<button class="btn btn-sm btn-circle btn-ghost absolute top-2 right-2">
				âœ•
			</button>
		</form>

		{
			isNotFound ? (
				<h2 class="text-lg font-bold">Stats not found</h2>
			) : (
				<>
					<h2 class="text-lg font-bold">
						Stats history for {account.username}
					</h2>

					<div class="mt-4 flex flex-col gap-4">
						{account.snapshots.map(({ snapshotDate, ...stats }, idx) => (
							<div class="flex gap-2">
								<div class="text-sm font-medium">{snapshotDate}</div>
								<div class="flex flex-1 flex-wrap gap-1">
									{STAT_COLUMNS.map((column) => (
										<StatsBadge
											label={column}
											value={stats[column]}
											previousValue={
												idx === 0 ? null : account.snapshots[idx - 1]![column]
											}
										/>
									))}
								</div>
							</div>
						))}
					</div>
				</>
			)
		}
	</div>

	<form method="dialog" class="contents">
		<button class="modal-backdrop">Close</button>
	</form>
</dialog>
