---
import { STAT_COLUMNS } from "@bandori-stats/database/constants";
import { titleCase } from "text-case";

import BaseLayout from "~/layouts/base-layout.astro";
import { parseSearchParams } from "./_params";

const { rank_by, sort_latest } = parseSearchParams(Astro.url.searchParams);

const rowsLink = new URL("/leaderboard/rows", Astro.url).href;
---

<BaseLayout>
	<div id="scroll-container" class="absolute inset-0 overflow-x-auto">
		<div class="sticky left-0 z-20 flex items-center gap-2 p-4 pb-2 sm:px-8">
			<h1 class="text-xl font-bold">Leaderboard</h1>
		</div>

		<table class="table-xs table-zebra table">
			<thead
				hx-target="tbody"
				hx-disabled-elt="input, label.btn"
				hx-indicator="#full-loader, tbody"
				hx-swap="innerHTML transition:true"
				hx-trigger="change delay:500ms"
				hx-include="closest tr"
				hx-sync="closest tr:replace"
				hx-on:htmx-before-request="this.closest('#scroll-container').scrollTo({ top: 0, behavior: 'smooth'})"
			>
				<tr class="bg-base-100 sticky top-0 z-20">
					<th class="min-w-10"></th>
					<th class="min-w-42">Username</th>
					<th class="min-w-24">
						<input
							id="sort_latest"
							type="checkbox"
							class="peer sr-only"
							name="sort_latest"
							value="true"
							checked={sort_latest}
							aria-label="Sort by last updated"
							hx-get={rowsLink}
						/>
						<label
							for="sort_latest"
							class="btn btn-xs not-peer-checked:btn-ghost peer-checked:btn-secondary"
						>
							Last Updated
							<iconify-icon
								icon="lucide:arrow-down-1-0"
								width="none"
								class="size-3"></iconify-icon>
						</label>
					</th>

					{
						STAT_COLUMNS.map((column) => (
							<th>
								<input
									type="checkbox"
									class="btn btn-xs btn-accent not-checked:btn-neutral not-checked:line-through"
									name="rank_by"
									value={column}
									checked={rank_by.includes(column)}
									aria-label={titleCase(column)}
									hx-get={rowsLink}
								/>
							</th>
						))
					}
				</tr>
			</thead>

			<tbody hx-indicator=".infinite-placeholder">
				<tr
					hx-get={rowsLink + Astro.url.search}
					hx-trigger="revealed"
					hx-swap="outerHTML"></tr>
			</tbody>

			<tfoot>
				{
					Array.from({ length: 12 }, () => (
						<tr class="infinite-placeholder htmx-indicator">
							{Array.from({ length: 3 + STAT_COLUMNS.length }, () => (
								<td>
									<div class="skeleton h-4" />
								</td>
							))}
						</tr>
					))
				}
			</tfoot>
		</table>

		<div id="full-loader" class="htmx-indicator center fixed">
			<iconify-icon icon="svg-spinners:bars-scale-fade" width="96"
			></iconify-icon>
		</div>
	</div>
</BaseLayout>
