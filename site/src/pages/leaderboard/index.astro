---
import { STAT_COLUMNS } from "@bandori-stats/database/constants";
import { redis } from "@bandori-stats/database/redis";
import dayjs from "dayjs";
import { titleCase } from "text-case";

import BaseLayout from "~/layouts/base-layout.astro";
import { parseSearchParams } from "./_params";

const { rank_by, sort_latest } = parseSearchParams(Astro.url.searchParams);

const rowsLink = new URL("/leaderboard/rows", Astro.url).href;

const { minDate, maxDate } = await (async () => {
	const [, [first]] = await redis.scan("0", {
		count: 1,
		match: `leaderboard:*:${STAT_COLUMNS[0]}`,
		type: "zset",
	});

	return {
		minDate: first.split(":")[1],
		maxDate: dayjs().format("YYYY-MM-DD"),
	};
})();
---

<BaseLayout>
	<div
		id="scroll-container"
		hx-include="[name='rank_by'], [name='sort_latest'], [name='date'], [name='search_username']"
		class="absolute inset-0 overflow-x-auto"
	>
		<div class="sticky left-0 z-20 flex items-center gap-2 p-4 pb-2 sm:px-8">
			<h1 class="text-xl font-bold">Leaderboard</h1>
			<input
				type="date"
				min={minDate}
				max={maxDate}
				class="input input-xs input-ghost w-28"
				name="date"
				value={maxDate}
				hx-get={rowsLink}
				hx-target="tbody"
				hx-disabled-elt="input, label.btn, select"
				hx-indicator="#app-loader, tbody"
				hx-swap="innerHTML transition:true"
			/>
		</div>

		<table class="table-xs table-zebra table">
			<thead
				hx-target="tbody"
				hx-disabled-elt="input, .btn"
				hx-indicator="#app-loader, tbody"
				hx-swap="innerHTML transition:true"
				hx-trigger="change delay:500ms"
				hx-sync="closest tr:replace"
				hx-on:htmx-before-request="this.closest('#scroll-container').scrollTo({ top: 0, behavior: 'smooth'})"
			>
				<tr class="bg-base-100 sticky top-0 z-20">
					<th class="min-w-10"></th>

					<th class="min-w-42">
						<div
							id="search_username_popover"
							popover
							class="dropdown peer bg-base-100 rounded-box z-1 mt-1 px-2 py-1 shadow-sm"
							style="position-anchor: --anchor-search-username; view-transition-name: search-username-popover;"
							hx-on:htmx-after-request="this.hidePopover()"
						>
							<input
								type="search"
								class="input input-xs w-32"
								name="search_username"
								placeholder="search..."
								hx-get={rowsLink}
								hx-trigger="input changed delay:1s"
							/>
						</div>

						<button
							class="btn btn-xs peer-has-placeholder-shown:btn-ghost peer-has-not-placeholder-shown:btn-primary"
							popovertarget="search_username_popover"
							style="anchor-name: --anchor-search-username"
						>
							Username

							<iconify-icon icon="lucide:search" width="none" class="size-3"
							></iconify-icon>
						</button>
					</th>

					<th class="min-w-24">
						<input
							id="sort_latest"
							type="checkbox"
							class="peer sr-only"
							name="sort_latest"
							value="true"
							checked={sort_latest}
							aria-label="Sort by last updated"
							hx-get={rowsLink}
						/>
						<label
							for="sort_latest"
							class="btn btn-xs not-peer-checked:btn-ghost peer-checked:btn-secondary"
						>
							Last Updated
							<iconify-icon
								icon="lucide:arrow-down-1-0"
								width="none"
								class="size-3"></iconify-icon>
						</label>
					</th>

					{
						STAT_COLUMNS.map((column) => (
							<th>
								<input
									type="checkbox"
									class="btn btn-xs btn-accent not-checked:btn-neutral not-checked:line-through"
									name="rank_by"
									value={column}
									checked={rank_by.includes(column)}
									aria-label={titleCase(column)}
									hx-get={rowsLink}
								/>
							</th>
						))
					}
				</tr>
			</thead>

			<tbody hx-indicator=".infinite-placeholder">
				<tr hx-get={rowsLink} hx-trigger="revealed" hx-swap="outerHTML"></tr>
			</tbody>

			<tfoot>
				{
					Array.from({ length: 12 }, () => (
						<tr class="infinite-placeholder htmx-indicator">
							{Array.from({ length: 3 + STAT_COLUMNS.length }, () => (
								<td>
									<div class="skeleton h-4" />
								</td>
							))}
						</tr>
					))
				}
			</tfoot>
		</table>
	</div>
</BaseLayout>
