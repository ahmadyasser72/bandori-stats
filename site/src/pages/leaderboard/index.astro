---
import { STAT_COLUMNS } from "@bandori-stats/database/constants";
import { titleCase } from "text-case";

import BaseLayout from "~/layouts/base-layout.astro";
import { RANK_BY } from "./_params";

const rankBy = RANK_BY.parse(Astro.url.searchParams.getAll("rank_by"));
---

<BaseLayout>
	<div id="scroll-container" class="absolute inset-0 overflow-x-auto">
		<div class="sticky left-0 z-20 flex items-center gap-2 p-4 pb-2 sm:px-8">
			<h1 class="text-xl font-bold">Leaderboard</h1>
		</div>

		<table class="table-xs table-zebra table">
			<thead>
				<tr
					hx-target="tbody"
					hx-disabled-elt="input"
					hx-indicator="#full-loader, tbody"
					hx-swap="innerHTML transition:true"
					class="bg-base-100 sticky top-0 z-10"
				>
					<th class="min-w-10"></th>
					<th class="min-w-42">Username</th>
					<th class="min-w-24">Last Updated</th>

					{
						STAT_COLUMNS.map((column) => (
							<th>
								<input
									type="checkbox"
									class="btn btn-xs btn-accent not-checked:btn-neutral not-checked:line-through"
									name="rank_by"
									value={column}
									checked={rankBy.includes(column)}
									aria-label={titleCase(column)}
									hx-get="/leaderboard/1"
									hx-trigger="change delay:500ms"
									hx-include="closest tr"
									hx-sync="closest tr:replace"
									hx-on:htmx-before-request="this.closest('#scroll-container').scrollTo({ top: 0, behavior: 'smooth'})"
								/>
							</th>
						))
					}
				</tr>
			</thead>

			<tbody hx-indicator=".infinite-placeholder">
				<tr hx-get="/leaderboard/1" hx-trigger="revealed" hx-swap="outerHTML"
				></tr>
			</tbody>

			<tfoot>
				{
					Array.from({ length: 12 }, () => (
						<tr class="infinite-placeholder htmx-indicator">
							{Array.from({ length: 3 + STAT_COLUMNS.length }, () => (
								<td>
									<div class="skeleton h-4" />
								</td>
							))}
						</tr>
					))
				}
			</tfoot>
		</table>

		<div id="full-loader" class="htmx-indicator center fixed">
			<iconify-icon icon="svg-spinners:bars-scale-fade" width="96"
			></iconify-icon>
		</div>
	</div>
</BaseLayout>
